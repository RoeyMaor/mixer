subject: namespace:ns
revision: "2022"
rules:
- selector: # must be empty for preprocessing adapters
  aspects:
  # when running local without a kubeconfig file specified in globalconfig,
  # this aspect should be commented out. It is only needed when the attributes
  # it produces are needed elsewhere in the config.
  - kind: attributes
    params:
      input_expressions:
        sourceUID: source.uid | ""
        sourceIP: source.ip | ip("0.0.0.0") # default to unspecified ip addr
        targetUID: target.uid | ""
        targetIP: target.ip | ip("0.0.0.0") # default to unspecified ip addr
      attribute_bindings:
        source.ip: sourcePodIp
        source.labels: sourceLabels
        source.name: sourcePodName
        source.namespace: sourceNamespace
        source.service: sourceService
        source.serviceAccount: sourceServiceAccountName
        target.ip: targetPodIp
        target.labels: targetLabels
        target.name: targetPodName
        target.namespace: targetNamespace
        target.service: targetService
        target.serviceAccount: targetServiceAccountName
  - kind: attributes
    adapter: token
    params:
      input_expressions:
        authorizationHeader: request.headers["authorization"] | ""
      attribute_bindings:
        request.token.exists: request.token.exists
        request.token.encrypted: request.token.encrypted
        request.token.type: request.token.type
        request.token.valid: request.token.valid
        request.token.signed: request.token.signed
        request.token.signAlg: request.token.signAlg
        request.token.claims: request.token.claims
  - kind: quotas
    params:
      quotas:
      - descriptorName: RequestCount
        maxAmount: 5000
        expiration: 1s
  - kind: metrics
    adapter: prometheus
    params:
      metrics:
      - descriptor_name: request_count
        # we want to increment this counter by 1 for each unique (source, target, service, method, response_code) tuple
        value: "1"
        labels:
          source: source.labels["app"] | "unknown"
          target: target.service | "unknown"
          service: target.labels["app"] | "unknown"
          method: request.path | "unknown"
          version: target.labels["version"] | "unknown"
          response_code: response.code | 200
      - descriptor_name:  request_duration
        value: response.latency | response.duration | "0ms"
        labels:
          source: source.labels["app"] | "unknown"
          target: target.service | "unknown"
          service: target.labels["app"] | "unknown"
          method: request.path | "unknown"
          version: target.labels["version"] | "unknown"
          response_code: response.code | 200
  - kind: access-logs
    params:
      logName: access_log
      log:
        descriptor_name: accesslog.common
        template_expressions:
           origin.ip: origin.ip
           origin.uid: origin.uid
           origin.user: origin.user
           request.time: request.time
           method: request.method
           request.path: request.path
           request.scheme: request.scheme
           response.code: response.code
           response.size: response.size
        labels:
           origin.ip: origin.ip
           origin.uid: origin.uid
           origin.user: origin.user
           request.path: request.path
           request.id: request.id
           request.host: request.host
           request.reason: request.reason
           request.referer: request.referer
           request.scheme: request.scheme
           request.size: request.size
           request.time: request.time
           request.headers: request.headers # STRING_MAP
           response.duration: response.duration
           response.headers: response.headers
           response.latency: response.latency
           response.time: response.time
           response.code: response.code
           response.size: response.size
           #method: request.method
           source.uid: source.uid
           target.uid: target.uid
           connection.id: connection.id
           connection.received.bytes: connection.received.bytes
           connection.received.bytes_total: connection.received.bytes_total
           connection.sent.bytes: connection.sent.bytes
           connection.sent.bytes_total: connection.sent.bytes_total
           connection.duration: connection.duration
           connection.protocol: connection.protocol
           connection.timestamp: connection.timestamp
           connection.time: connection.time
           source.ip: source.ip
           source.labels: source.labels
           source.name: source.name
           source.namespace: source.namespace
           source.service: source.service
           source.serviceAccount: source.serviceAccount
           target.ip: target.ip
           target.labels: target.labels
           target.name: target.name
           target.namespace: target.namespace
           target.service: target.service
           target.serviceAccount: target.serviceAccount


